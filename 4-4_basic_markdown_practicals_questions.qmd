## Markdown: Questions {.unnumbered}

We will continue analyzing the file `R_data2.csv`, the data about children with intellectual disabilities. We are going to do an analysis in R using Quarto to produce an html file that contains both the documentation, code and the results. Unfortunately, because we create a dynamic document of our data analyses that changes as we go, it is a bit harder to provide  answers after every question in the same way as before. To help you, we provide a model 'answer'  that reflects what the finished R markdown document may look like when you have answered all questions.

This practical demonstrates **reproducible research** - creating a dynamic document where your analysis, code, and results are all in one place and can be easily updated as data or methods change.

Open RStudio to do the practicals. Note that questions marked with ðŸŽ“ are optional.

::: {.panel-tabset .nav-pills}

### Question 1

We are going to make an Quarto document for our analysis. A convenient way to start editing such a document in R studio is by using the menu bar. Select 'file' -> 'New File' -> 'Quarto Document ...'. This will open a dialog box where you can select the type of document you want to create. Select 'Document' and then 'HTML'. Choose 'Analysis of Intellectual Disabilities' as a title and fill in your name. This will create a new R markdown document with some default text (which we will delete for the most part). Save this document somewhere on your computer or network.

Structure the document by creating headers for the different sections. You can use the following headers: n use the following headers:
- 'Introduction'
- 'Data'
- 'Analysis and Results'
- 'Conclusion and Discussion' 

#### Hint 1
 
When using the RStudio template this should not give any problems. Remember that the markdown code to start a section consists of two hashes `##`.

:::

::: {.panel-tabset .nav-pills}
### Question 2

Now we are going to load the data set `R_data2.csv` into R. To do so insert a code chunk in the introduction section. You can do this by choosing 'Code > 'Insert Chunk' from the menu. Now begin to enter the necessary code (check the practical from day 2 if needed to see how this can be done). Call the imported data set 'dat'. 

At this point try to 'knit' or 'render' the document to see if there are no errors. You can check this at the end of every question.

:::

#### Hint 2
 
The code chunk you should insert in the Setup section should look something like this:
 
```{r eval=FALSE}
dat <- read.csv("Data/R_data2.csv")
```
 
Note: You may need to adjust the file path depending on where your data is stored.

::: {.panel-tabset .nav-pills}
### Question 3

Create a new code chunk in the 'Data' section of your document. This is where we will clean the data and apply the necessary transformations. 

* Define the variable `pregnancy_length` by adding together the weeks and days as you have done in the practical about data cleaning. 

*  Define the variable `BMI_cat` by dividing the variable BMI into categories: <18.5 ("Underweight"), 18.5 - 24.9 ("Healthy weight"), 25 - 29.9 ("Overweight"), and >30 (Obesity).

* log transform `homocysteine` and `vitaminB12`.

* Transform the categorical variables to factors. For the `Status` variable. Make sure that "normal brain development" is the first so it will be used as reference in the logistic regression we will do later.

* Remove the original variables `pregnancy_length_weeks`, `pregnancy_length_days`,  `BMI` and `homocysteine` and `vitaminB12` from the data set, we will not use them any further.

* Add a short text underneath the code chunk explaining what you have done.

#### Hint 3
 
You can carry out all the transformations using code like:
 
```{r eval=FALSE}
dat$pregnancy_length <- dat$pregnancy_length_weeks * 7 +
    dat$pregnancy_length_days
 
dat$BMI_cat <- cut(dat$BMI, breaks=c(-Inf, 18.5, 24.9, 29.9, Inf),
                   labels=c("Underweight", "Healthy weight",
                           "Overweight", "Obesity"))
 
dat$log_homocysteine <- log(dat$homocysteine)
dat$log_vitaminB12 <- log(dat$vitaminB12)
 
# Convert character variables to factors
for(i in 1:length(names(dat))){
  if(class(dat[[i]]) == "character"){
    dat[[i]] <- as.factor(dat[[i]])
  }
}
 
# Set reference level for Status
dat$Status <- factor(dat$Status,
                    levels = c("normal brain development",
                              "intellectual disability"))
 
# Remove original variables
dat <- dat[, !(names(dat) %in% c("pregnancy_length_weeks",
                                  "pregnancy_length_days",
                                  "BMI", "homocysteine", "vitaminB12"))]
```


:::



::: {.panel-tabset .nav-pills}
### Question 4

It is always a good idea to get to know your data. To this and add a subsection to the 'Analysis and Results' section where you compute the mean and standard deviation (you can calculate them with the `mean` and `sd` functions) for all continuous variables in the data set and the frequency of all categorical variables (for example by using the `table` function). You might want to use your knowledge of loops (see the material from the 3rd day of the course) to do this efficiently.

::: {.callout-tip}
## Packages

There are a number of useful packages to create tables of descriptives like this. Because it is beyond the scope of this course we will not use them here. However you might be interested in checking out the `table1` and `gtsummary` packages.
:::

Also add a histogram of the continuous variables. 

#### Hint 4
 
To get the descriptives for all variables in the data set you can use the following code template:
 
```{r eval=FALSE}
for(i in 1:length(names(dat))){
  if(class(dat[[i]]) == "numeric"){
    # Calculate mean and sd for numeric variables
    cat(names(dat)[i], ":\n")
    cat("  Mean:", mean(dat[[i]], na.rm = TRUE), "\n")
    cat("  SD:", sd(dat[[i]], na.rm = TRUE), "\n\n")
  } else if(class(dat[[i]]) == "factor"){
    # Get frequency table for factor variables
    cat(names(dat)[i], ":\n")
    print(table(dat[[i]]))
    cat("\n")
  }
}
```
 
Histograms can be created in a similar loop. To make the actual plot use the `hist()` function.

:::

::: {.panel-tabset .nav-pills}
### Question 5

Add a subsection "Unadjusted Analysis" to the 'Analysis and Results' section where you compare the mean of the logarithm of the Vitamin B12 for the two levels of `Status` (normal brain development or intellectual disability). 

#### Hint 5
 
Use the `t.test()` or `wilcox.test()` function to compare the mean of the logarithm of Vitamin B12 for the two levels of `Status`:
 
```{r eval=FALSE}
t.test(log_vitaminB12 ~ Status, data = dat)
```

:::

::: {.panel-tabset .nav-pills}
### Question 6 

Add a subsection adjusted analysis to the 'Analysis and Results' section where you perform logistic regression analysis to investigate the association between `Status` and log `Vitamin B12` while adjusting for `medication`, `smoking` and `alcohol`.

:::

#### Hint 6
 
Use the `glm()` function to perform logistic regression analysis:
 
```{r eval=FALSE}
glm1_adjusted <- glm(Status ~ log_vitaminB12 + medication + smoking + alcohol,
                     data = dat,
                     family = binomial)
 
summary(glm1_adjusted)
```

Use the `summary()`, `coef()` and `confint()` functions to extract the relevant details (coefficients, p-values, and confidence intervals).

::: {.panel-tabset .nav-pills}
### Question 7

Now adjust the text the text of the document to better explain what you have done. 

End your document with a paragraph of conclusions. Use bold text an unnumbered list to summarize the main points.

#### Hint 7

State your conclusions from both the adjusted and unadjusted analyses. Consider:
  - What did you find regarding the association between Vitamin B12 and intellectual disability?
  - How did adjusting for confounders change the results?
  - What are the implications of your findings?

:::

::: {.panel-tabset .nav-pills}

### Question 8 

Change the options of the code chunks in your document that do the data transformations to prevent showing the code and messages. This will make the document more readable at the expense of no longer being fully transparent.

Also check what happens if you add `code_folding: hide` to the YAML header of your document (under `html`). 

#### Hint 8
 
To hide code in a chunk, use the chunk option `#| echo: false`:
 
```{r eval=FALSE}
#| echo: false
# Your code here
```
 
To suppress messages, add `#: message: false`:
 
```{r eval=FALSE}
#| echo: false
#| message: false
# Your code here
```
 
In the YAML header, you can add:
```yaml
output:
  html:
    code_folding: hide
```
:::

::: callout-advanced

::: {.panel-tabset .nav-pills}

### Question 9 ðŸŽ“

Outliers can have a large effect on results. For the purpose of this practical we will consider all observations that are 3 standard deviations away from the mean as outliers. In the data section transform the data set by truncating the outliers to the value of the mean plus or minus 3 times the standard deviation. This is called 'Winsorizing'. Try to write your own function to do this using what you have learned during day 3 of the course. For Winsorizing `homocysteine` and `vitaminB12` are analysed on the log scale. 

Rerun your analyses. Describe what you have done in the text. Adjust your conclusions if needed.

::: {.callout-note}

Obviously, in a real life situation the handling of outliers would require some more thought.

:::

#### Hint 9*
 
Here's a template for a Winsorizing function:
 
```{r eval=FALSE}
winsorize <- function(x, n_sd = 3) {
  # Calculate mean and sd
  mean_x <- mean(x, na.rm = TRUE)
  sd_x <- sd(x, na.rm = TRUE)
 
  # Calculate bounds
  lower_bound <- mean_x - n_sd * sd_x
  upper_bound <- mean_x + n_sd * sd_x
 
  # Truncate values
  x[x < lower_bound] <- lower_bound
  x[x > upper_bound] <- upper_bound
 
  return(x)
}
 
# Apply to variables
dat$log_homocysteine <- winsorize(dat$log_homocysteine)
dat$log_vitaminB12 <- winsorize(dat$log_vitaminB12)
```

:::

::: {.panel-tabset .nav-pills}

### Question 10 ðŸŽ“

It has been discovered that a mistake has been made in the construction of the data set. Some participants have 
accidentally been excluded while others have been excluded while they should not have been. The file `extra.Rdata` contains data of new participants that should be included. The data `ineexcl.Rdata` contains the `ids` of patients that should be excluded. 

Adjust your data to reflect this new information. Check for duplicate IDs after the inclusion (e.g. by using `anyDuplicated()`). Rerun your analysis and adjust your conclusions if needed.

#### Hint 10*
 
Load the additional data files and update your dataset:
 
```{r eval=FALSE}
# Load additional data
load("extra.Rdata")  # This should create an object with new patients
load("inexcl.Rdata")  # This should create a vector of IDs to exclude
 
# Remove patients that should be excluded
dat <- dat[!(dat$id %in% inexcl), ]
 
# Add new patients
dat <- rbind(dat, extra)
```
 
After updating the data, rerun all your analyses and update the text and conclusions accordingly.
:::

:::

